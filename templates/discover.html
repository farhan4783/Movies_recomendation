{% extends "base.html" %}

{% block title %}Discover ‚Äî Movie Maverick{% endblock %}

{% block head %}
<style>
    /* ===== DISCOVER PAGE ===== */
    .discover-hero {
        text-align: center;
        padding: 4rem 0 3rem;
    }

    .discover-hero h1 {
        font-size: clamp(2.5rem, 6vw, 4rem);
        font-weight: 800;
        background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.6) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
    }

    .discover-hero p {
        font-size: 1.15rem;
        color: var(--text-secondary);
        max-width: 500px;
        margin: 0 auto;
    }

    /* ===== MOOD SELECTOR ===== */
    .mood-section {
        margin-bottom: 4rem;
    }

    .section-label {
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--primary-color);
        margin-bottom: 1.25rem;
    }

    .mood-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 1rem;
    }

    .mood-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.5rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.19, 1, 0.22, 1);
        user-select: none;
    }

    .mood-card:hover,
    .mood-card.selected {
        background: rgba(229, 9, 20, 0.12);
        border-color: var(--primary-color);
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(229, 9, 20, 0.2);
    }

    .mood-card.selected {
        background: rgba(229, 9, 20, 0.2);
    }

    .mood-emoji {
        font-size: 2.2rem;
        display: block;
        margin-bottom: 0.6rem;
    }

    .mood-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .mood-card.selected .mood-label {
        color: var(--text-primary);
    }

    .mood-get-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        margin-top: 1.5rem;
        padding: 0.85rem 2rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 4px 20px rgba(229, 9, 20, 0.4);
    }

    .mood-get-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(229, 9, 20, 0.5);
    }

    .mood-get-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* ===== MOOD RESULTS ===== */
    #mood-results {
        margin-top: 2.5rem;
    }

    .mood-result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1.25rem;
        margin-top: 1.5rem;
    }

    /* ===== GENRE TILES ===== */
    .genre-section {
        margin-bottom: 4rem;
    }

    .genre-tiles {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }

    .genre-tile {
        position: relative;
        border-radius: 18px;
        overflow: hidden;
        cursor: pointer;
        aspect-ratio: 16/9;
        transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        border: 1px solid rgba(255, 255, 255, 0.07);
    }

    .genre-tile:hover {
        transform: scale(1.04);
        z-index: 2;
    }

    .genre-tile:hover .genre-bg {
        filter: brightness(0.7);
    }

    .genre-bg {
        position: absolute;
        inset: 0;
        transition: filter 0.3s ease;
    }

    .genre-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        z-index: 1;
    }

    .genre-emoji {
        font-size: 2rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .genre-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        letter-spacing: 0.03em;
    }

    /* Genre gradients */
    .genre-action    { background: linear-gradient(135deg, #c0392b, #8e44ad); }
    .genre-comedy    { background: linear-gradient(135deg, #f39c12, #e74c3c); }
    .genre-drama     { background: linear-gradient(135deg, #2980b9, #6dd5fa); }
    .genre-horror    { background: linear-gradient(135deg, #0d0d0d, #4a0000); }
    .genre-sci-fi    { background: linear-gradient(135deg, #1a1a2e, #16213e); }
    .genre-romance   { background: linear-gradient(135deg, #e91e63, #f06292); }
    .genre-thriller  { background: linear-gradient(135deg, #2c3e50, #4ca1af); }
    .genre-animation { background: linear-gradient(135deg, #43e97b, #38f9d7); }
    .genre-adventure { background: linear-gradient(135deg, #f7971e, #ffd200); }
    .genre-fantasy   { background: linear-gradient(135deg, #6a3093, #a044ff); }
    .genre-crime     { background: linear-gradient(135deg, #1c1c1c, #636363); }
    .genre-mystery   { background: linear-gradient(135deg, #1a1a2e, #374785); }
    .genre-default   { background: linear-gradient(135deg, #373b44, #4286f4); }

    /* ===== QUICK SEARCH ===== */
    .quick-search-section {
        margin-bottom: 4rem;
    }

    .quick-search-bar {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .quick-search-bar input {
        flex: 1;
    }

    .discover-recs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1.25rem;
    }

    /* Card identical to movie-card but slightly smaller */
    .disc-card {
        border-radius: 14px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.07);
        position: relative;
    }

    .disc-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .disc-poster {
        width: 100%;
        aspect-ratio: 2/3;
        object-fit: cover;
        display: block;
    }

    .disc-info {
        padding: 0.75rem;
    }

    .disc-title {
        font-size: 0.85rem;
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 0.3rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .disc-meta {
        font-size: 0.78rem;
        color: var(--text-secondary);
        display: flex;
        gap: 0.5rem;
    }

    /* Loading skeleton for disc cards */
    .disc-card-skeleton {
        aspect-ratio: 2/3;
        background: rgba(255,255,255,0.04);
        border-radius: 14px;
        animation: pulse 1.5s ease-in-out infinite alternate;
    }

    /* Spinner inside button */
    .btn-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.4);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @media (max-width: 640px) {
        .genre-tiles { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        .mood-grid   { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">

    <!-- Hero -->
    <div class="discover-hero" data-animate="fadeInUp">
        <h1>‚ú® Discover</h1>
        <p>Browse by genre, match your mood, or find something totally new.</p>
    </div>

    <!-- ===== MOOD PICKER ===== -->
    <section class="mood-section">
        <div class="section-label">üé≠ What's your mood right now?</div>
        <div class="mood-grid">
            {% set moods = [
                ('üòÇ', 'Laugh Out Loud', 'happy'),
                ('üò≠', 'Cry it Out', 'sad'),
                ('üò®', 'Scared Stiff', 'scared'),
                ('ü§©', 'Totally Wowed', 'excited'),
                ('üß†', 'Mind Blown', 'thoughtful'),
                ('‚ù§Ô∏è', 'Feeling Romantic', 'romantic'),
                ('üò§', 'Need Action', 'action'),
                ('üåô', 'Chill Night', 'chill')
            ] %}
            {% for emoji, label, value in moods %}
            <div class="mood-card" data-mood="{{ value }}" onclick="selectMood(this)">
                <span class="mood-emoji">{{ emoji }}</span>
                <div class="mood-label">{{ label }}</div>
            </div>
            {% endfor %}
        </div>

        <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap; margin-top:1.5rem;">
            <button class="mood-get-btn" id="mood-btn" onclick="getMoodRecs()" disabled>
                <span id="mood-btn-text">‚ú® Get Picks</span>
            </button>
            <span style="font-size:0.85rem; color:var(--text-secondary);">Pick a mood above to start</span>
        </div>

        <div id="mood-results"></div>
    </section>

    <!-- ===== GENRE TILES ===== -->
    <section class="genre-section">
        <div class="section-label">üé¨ Browse by Genre</div>
        <div class="genre-tiles">
            {% set genre_map = {
                'Action': ('üí•', 'genre-action'),
                'Comedy': ('üòÇ', 'genre-comedy'),
                'Drama': ('üé≠', 'genre-drama'),
                'Horror': ('üëª', 'genre-horror'),
                'Sci-Fi': ('üöÄ', 'genre-sci-fi'),
                'Science Fiction': ('üöÄ', 'genre-sci-fi'),
                'Romance': ('‚ù§Ô∏è', 'genre-romance'),
                'Thriller': ('üî™', 'genre-thriller'),
                'Animation': ('üé®', 'genre-animation'),
                'Adventure': ('üó∫Ô∏è', 'genre-adventure'),
                'Fantasy': ('üßô', 'genre-fantasy'),
                'Crime': ('üïµÔ∏è', 'genre-crime'),
                'Mystery': ('üîç', 'genre-mystery')
            } %}

            {% for genre in genres[:20] %}
                {% if genre in genre_map %}
                    {% set emoji, cls = genre_map[genre] %}
                {% else %}
                    {% set emoji = 'üé¨' %}
                    {% set cls = 'genre-default' %}
                {% endif %}
            <div class="genre-tile" onclick="browseGenre('{{ genre | urlencode }}')" title="{{ genre }}">
                <div class="genre-bg {{ cls }}"></div>
                <div class="genre-overlay">
                    <span class="genre-emoji">{{ emoji }}</span>
                    <span class="genre-name">{{ genre }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- ===== TRENDING SECTION ===== -->
    <section class="quick-search-section">
        <div class="section-label">üî• Trending Right Now</div>
        <div class="discover-recs-grid" id="trending-grid">
            {% for _ in range(8) %}
            <div class="disc-card-skeleton"></div>
            {% endfor %}
        </div>
    </section>

</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedMood = null;

    function selectMood(el) {
        document.querySelectorAll('.mood-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        selectedMood = el.dataset.mood;
        document.getElementById('mood-btn').disabled = false;
    }

    async function getMoodRecs() {
        if (!selectedMood) return;

        const btn = document.getElementById('mood-btn');
        const btnText = document.getElementById('mood-btn-text');
        btn.disabled = true;
        btnText.innerHTML = '<span class="btn-spinner"></span> Finding picks...';

        // Map mood ‚Üí modyverse-style answers
        const moodMap = {
            happy:        { mood: 'Happy', story_type: 'Lighthearted', company: 'Anyone' },
            sad:          { mood: 'Sad', story_type: 'Emotional', company: 'Solo' },
            scared:       { mood: 'Anxious', story_type: 'Suspenseful', company: 'Solo' },
            excited:      { mood: 'Excited', story_type: 'Epic Adventure', company: 'Friends' },
            thoughtful:   { mood: 'Curious', story_type: 'Mind-Bending', company: 'Solo' },
            romantic:     { mood: 'Romantic', story_type: 'Love Story', company: 'Partner' },
            action:       { mood: 'Pumped', story_type: 'Action Packed', company: 'Friends' },
            chill:        { mood: 'Relaxed', story_type: 'Feel-Good', company: 'Solo' },
        };

        const answers = moodMap[selectedMood] || { mood: selectedMood, story_type: 'Any', company: 'Solo' };

        try {
            const res = await fetch('/api/modyverse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(answers),
            });
            const data = await res.json();
            const container = document.getElementById('mood-results');
            if (data.html) {
                container.innerHTML = `
                    <div class="section-label" style="margin-top:2rem;">üéØ Recommended for your mood</div>
                    <div class="glass-panel" style="padding:1.5rem; border-radius:16px; margin-top:1rem;">
                        ${data.html}
                    </div>`;
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                container.innerHTML = '<p style="color:var(--text-secondary); margin-top:1rem;">Could not get picks. Try again!</p>';
            }
        } catch (e) {
            document.getElementById('mood-results').innerHTML =
                '<p style="color:var(--text-secondary); margin-top:1rem;">Error fetching recommendations.</p>';
        } finally {
            btn.disabled = false;
            btnText.textContent = '‚ú® Get Picks';
        }
    }

    function browseGenre(genre) {
        window.location.href = `/charts?genre=${genre}`;
    }

    // ===== Load Trending =====
    async function loadTrending() {
        try {
            const res = await fetch('/api/trending?window=week');
            const data = await res.json();
            const grid = document.getElementById('trending-grid');

            if (!data.results || data.results.length === 0) {
                grid.innerHTML = '<p style="color:var(--text-secondary);">No trending data available.</p>';
                return;
            }

            grid.innerHTML = data.results.slice(0, 8).map(m => {
                const href = m.id ? `/movie/id/${m.id}` : `/movie/${encodeURIComponent(m.title || '')}`;
                const year = (m.release_date || '').slice(0, 4);
                return `
                <div class="disc-card" onclick="window.location.href='${href}'">
                    ${m.poster_path
                        ? `<img src="${m.poster_path}" alt="${m.title}" class="disc-poster" loading="lazy">`
                        : `<div class="disc-poster" style="display:flex;align-items:center;justify-content:center;font-size:3rem;background:rgba(255,255,255,0.04);">üé¨</div>`
                    }
                    <div class="disc-info">
                        <div class="disc-title">${m.title || ''}</div>
                        <div class="disc-meta">
                            <span>‚≠ê ${m.vote_average || 'N/A'}</span>
                            ${year ? `<span>${year}</span>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        } catch (e) {
            document.getElementById('trending-grid').innerHTML =
                '<p style="color:var(--text-secondary);">Could not load trending movies.</p>';
        }
    }

    window.addEventListener('load', loadTrending);
</script>
{% endblock %}
