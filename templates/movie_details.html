{% extends "base.html" %}

{% block title %}{{ movie.title }} - Movie Maverick{% endblock %}

{% block content %}
<div class="movie-page">
    <!-- Hero Section with Backdrop -->
    <div class="movie-hero" style="
        position: relative;
        height: 85vh;
        min-height: 600px;
        background-image: url('{{ movie.backdrop_path }}');
        background-size: cover;
        background-position: center top;
        background-repeat: no-repeat;
        margin-top: -6rem;
    ">
        <div class="hero-overlay" style="
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, var(--background-color) 0%, rgba(5,5,5,0.75) 50%, rgba(5,5,5,0.25) 100%);
        "></div>

        <div class="container"
            style="position: relative; height: 100%; display: flex; align-items: flex-end; padding-bottom: 4rem;">

            <!-- Back Button -->
            <button onclick="history.back()" style="
                position: absolute;
                top: 7rem;
                left: 2rem;
                background: rgba(0,0,0,0.55);
                border: 1px solid rgba(255,255,255,0.2);
                border-radius: 10px;
                color: white;
                padding: 0.5rem 1.1rem;
                cursor: pointer;
                font-family: inherit;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                backdrop-filter: blur(8px);
                transition: all 0.2s;
            " onmouseover="this.style.background='rgba(255,255,255,0.15)'"
                onmouseout="this.style.background='rgba(0,0,0,0.55)'">
                ‚Üê Back
            </button>

            <div class="hero-content"
                style="display: flex; gap: 3rem; align-items: flex-end; width: 100%; flex-wrap: wrap;">

                <!-- Poster -->
                <div class="poster-wrapper" style="flex-shrink: 0;">
                    <img src="{{ movie.poster_path or 'https://via.placeholder.com/300x450' }}" alt="{{ movie.title }}"
                        style="
                        width: 280px;
                        border-radius: 16px;
                        box-shadow: 0 25px 60px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.08);
                        transition: transform 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                </div>

                <!-- Text Info -->
                <div class="movie-details-text" style="flex: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">
                    <h1
                        style="font-size: clamp(1.8rem, 5vw, 3.5rem); margin-bottom: 0.5rem; line-height: 1.1; font-weight: 800;">
                        {{ movie.title }}
                        <span style="font-weight: 300; color: #aaa; font-size: clamp(1rem, 2.5vw, 1.8rem);">({{
                            movie.release_date[:4] if movie.release_date else 'N/A' }})</span>
                    </h1>

                    <div class="meta-tags"
                        style="display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <span class="rating-badge" style="
                            background: rgba(255, 215, 0, 0.15);
                            color: #ffd700;
                            padding: 0.35rem 0.9rem;
                            border-radius: 8px;
                            border: 1px solid rgba(255, 215, 0, 0.35);
                            font-weight: 800;
                            font-size: 1rem;
                        ">‚≠ê {{ movie.vote_average | round(1) }}</span>

                        {% if movie.runtime %}
                        <span class="runtime" style="color: #ccc; font-size: 0.95rem;">‚è±Ô∏è {{ movie.runtime }} min</span>
                        {% endif %}

                        {% for genre in movie.genres %}
                        <span class="genre-tag" style="
                            background: rgba(255, 255, 255, 0.1);
                            padding: 0.3rem 0.8rem;
                            border-radius: 20px;
                            font-size: 0.85rem;
                            backdrop-filter: blur(5px);
                            border: 1px solid rgba(255,255,255,0.12);
                        ">{{ genre }}</span>
                        {% endfor %}

                        {% if movie.watch_providers and movie.watch_providers.flatrate %}
                        <span style="
                            background: rgba(74, 222, 128, 0.15);
                            color: #4ade80;
                            padding: 0.3rem 0.8rem;
                            border-radius: 8px;
                            border: 1px solid rgba(74, 222, 128, 0.3);
                            font-weight: 700;
                            font-size: 0.85rem;
                        ">‚ñ∂ Streaming Now</span>
                        {% endif %}
                    </div>

                    {% if movie.tagline %}
                    <p class="tagline"
                        style="font-style: italic; color: #bbb; font-size: 1.1rem; margin-bottom: 1.5rem;">"{{
                        movie.tagline }}"
                    </p>
                    {% endif %}

                    <div class="overview-section" style="margin-bottom: 2rem;">
                        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Overview</h3>
                        <p class="overview"
                            style="font-size: 1.05rem; line-height: 1.7; color: #ddd; max-width: 750px;">
                            {{ movie.overview }}
                        </p>
                    </div>

                    <div class="action-buttons"
                        style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
                        {% if current_user.is_authenticated %}
                        <button id="watchlist-btn" class="primary-btn {{ 'active' if in_watchlist else '' }}"
                            onclick='toggleWatchlist()'
                            style="{{ 'background: #333; border: 1px solid var(--primary-color);' if in_watchlist else '' }}">
                            {{ '‚úì In Watchlist' if in_watchlist else '+ Add to Watchlist' }}
                        </button>
                        {% else %}
                        <a href="/login?next={{ request.path }}" class="primary-btn">Login to Add to Watchlist</a>
                        {% endif %}

                        <!-- Social Share Buttons -->
                        <div class="share-btn-group" style="display: flex; gap: 0.5rem;">
                            <button class="share-btn" id="share-x" onclick="shareOnX()" title="Share on X"
                                style="background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 0.55rem 0.9rem; color: white; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; font-family: inherit; display: flex; align-items: center; gap: 0.4rem;">
                                ùïè Share
                            </button>
                            <button class="share-btn" id="share-wa" onclick="shareOnWhatsApp()"
                                title="Share on WhatsApp"
                                style="background: rgba(37,211,102,0.15); border: 1px solid rgba(37,211,102,0.3); border-radius: 10px; padding: 0.55rem 0.9rem; color: #25d366; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; font-family: inherit; display: flex; align-items: center; gap: 0.4rem;">
                                üì± WhatsApp
                            </button>
                            <button class="share-btn" id="share-copy" onclick="copyLink()" title="Copy link"
                                style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; padding: 0.55rem 0.9rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; font-size: 0.85rem; font-family: inherit; display: flex; align-items: center; gap: 0.4rem;">
                                üîó Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Data Injection -->
    <script id="movie-data" type="application/json">
        {{ movie | tojson | safe }}
    </script>

    <div class="container main-content" style="padding-top: 2rem;">

        <!-- Cast Section -->
        {% if movie.cast %}
        <section class="cast-section" style="margin-bottom: 4rem;">
            <h2 style="border-left: 4px solid var(--primary-color); padding-left: 1rem; margin-bottom: 2rem;">Top Cast
            </h2>
            <div class="cast-grid" style="
                display: flex;
                overflow-x: auto;
                gap: 1.25rem;
                padding-bottom: 1.5rem;
                scrollbar-width: thin;
                scrollbar-color: var(--primary-color) #222;
            ">
                {% for actor in movie.cast %}
                <div class="cast-card glass-panel"
                    style="min-width: 140px; width: 140px; overflow: hidden; flex-shrink: 0; text-align: center; padding-bottom: 0.75rem;">
                    <div style="overflow: hidden;">
                        <img src="{{ actor.profile_path or 'https://via.placeholder.com/140x200?text=?' }}"
                            alt="{{ actor.name }}"
                            style="width: 100%; height: 175px; object-fit: cover; object-position: top; transition: transform 0.3s;"
                            onmouseover="this.style.transform='scale(1.06)'"
                            onmouseout="this.style.transform='scale(1)'">
                    </div>
                    <div class="cast-info" style="padding: 0.75rem 0.6rem 0;">
                        <p class="actor-name"
                            style="font-weight: 700; font-size: 0.85rem; margin-bottom: 0.2rem; line-height: 1.3;">{{
                            actor.name }}</p>
                        <p class="character-name"
                            style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.3;">{{
                            actor.character }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}


        {% if movie.watch_providers and (movie.watch_providers.flatrate or movie.watch_providers.rent or
        movie.watch_providers.buy) %}
        <section class="watch-providers-section" style="margin-bottom: 4rem;">
            <h2 style="border-left: 4px solid var(--primary-color); padding-left: 1rem; margin-bottom: 2rem;">Where to
                Watch</h2>

            <div class="glass-panel"
                style="padding: 2.5rem; border: 1px solid rgba(255, 215, 0, 0.1); background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,215,0,0.02) 100%);">
                {% if movie.watch_providers.flatrate %}
                <div class="provider-category" style="margin-bottom: 2.5rem;">
                    <h3
                        style="font-size: 1.2rem; margin-bottom: 1.25rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.6rem;">
                        <span style="color: #4ade80;">‚ñ∂</span> Subscription
                    </h3>
                    <div style="display: flex; gap: 1.25rem; flex-wrap: wrap; align-items: center;">
                        {% for provider in movie.watch_providers.flatrate %}
                        <div class="provider-item" style="
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 16px;
                            padding: 1rem 1.5rem;
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        " onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='translateY(-5px) scale(1.05)'; this.style.borderColor='rgba(255,215,0,0.3)'"
                            onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.transform='translateY(0) scale(1)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                            {% if provider.logo_path %}
                            <img src="https://image.tmdb.org/t/p/original{{ provider.logo_path }}"
                                alt="{{ provider.provider_name }}"
                                style="width: 44px; height: 44px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            {% elif provider.logo %}
                            <img src="{{ provider.logo }}" alt="{{ provider.name }}"
                                style="width: 44px; height: 44px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            {% endif %}
                            <span style="font-weight: 600; font-size: 1.05rem;">{{ provider.provider_name or
                                provider.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2.5rem;">
                    {% if movie.watch_providers.rent %}
                    <div class="provider-category">
                        <h3
                            style="font-size: 1.1rem; margin-bottom: 1.25rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.6rem;">
                            <span style="color: #60a5fa;">üí∞</span> Rent
                        </h3>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                            {% for provider in movie.watch_providers.rent %}
                            <div class="provider-item-small" style="
                                background: rgba(255, 255, 255, 0.04);
                                border: 1px solid rgba(255, 255, 255, 0.08);
                                border-radius: 12px;
                                padding: 0.6rem 1rem;
                                display: flex;
                                align-items: center;
                                gap: 0.7rem;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.04)'">
                                {% if provider.logo_path %}
                                <img src="https://image.tmdb.org/t/p/original{{ provider.logo_path }}"
                                    alt="{{ provider.provider_name }}"
                                    style="width: 28px; height: 28px; border-radius: 6px;">
                                {% elif provider.logo %}
                                <img src="{{ provider.logo }}" alt="{{ provider.name }}"
                                    style="width: 28px; height: 28px; border-radius: 6px;">
                                {% endif %}
                                <span style="font-size: 0.9rem;">{{ provider.provider_name or provider.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if movie.watch_providers.buy %}
                    <div class="provider-category">
                        <h3
                            style="font-size: 1.1rem; margin-bottom: 1.25rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.6rem;">
                            <span style="color: #f472b6;">üõí</span> Buy
                        </h3>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                            {% for provider in movie.watch_providers.buy %}
                            <div class="provider-item-small" style="
                                background: rgba(255, 255, 255, 0.04);
                                border: 1px solid rgba(255, 255, 255, 0.08);
                                border-radius: 12px;
                                padding: 0.6rem 1rem;
                                display: flex;
                                align-items: center;
                                gap: 0.7rem;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.08)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.04)'">
                                {% if provider.logo_path %}
                                <img src="https://image.tmdb.org/t/p/original{{ provider.logo_path }}"
                                    alt="{{ provider.provider_name }}"
                                    style="width: 28px; height: 28px; border-radius: 6px;">
                                {% elif provider.logo %}
                                <img src="{{ provider.logo }}" alt="{{ provider.name }}"
                                    style="width: 28px; height: 28px; border-radius: 6px;">
                                {% endif %}
                                <span style="font-size: 0.9rem;">{{ provider.provider_name or provider.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if movie.watch_providers.link %}
                <div
                    style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--glass-border); text-align: right;">
                    <a href="{{ movie.watch_providers.link }}" target="_blank" rel="noopener noreferrer"
                        style="color: #ffd700; font-size: 0.9rem; text-decoration: none; font-weight: 700; background: rgba(255,215,0,0.1); padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid rgba(255,215,0,0.2); transition: all 0.2s;">
                        Detailed Watch Options on TMDB ‚Üó
                    </a>
                </div>
                {% endif %}
            </div>
        </section>
        {% endif %}

        <!-- Reviews Section -->
        <section class="reviews-section" style="margin-bottom: 4rem;">
            <h2 style="border-left: 4px solid var(--primary-color); padding-left: 1rem; margin-bottom: 2rem;">User
                Reviews</h2>

            {% if current_user.is_authenticated %}
            <div class="glass-panel" style="padding: 2rem; margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Leave a Review</h3>
                <form id="review-form" onsubmit="submitReview(event)">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem;">Rating</label>
                        <div class="star-rating"
                            style="display: flex; gap: 0.5rem; font-size: 1.5rem; cursor: pointer;">
                            <span onclick="setRating(1)">‚òÖ</span>
                            <span onclick="setRating(2)">‚òÖ</span>
                            <span onclick="setRating(3)">‚òÖ</span>
                            <span onclick="setRating(4)">‚òÖ</span>
                            <span onclick="setRating(5)">‚òÖ</span>
                        </div>
                        <input type="hidden" name="rating" id="rating-input" required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem;">Comment</label>
                        <textarea name="comment" rows="3" placeholder="Share your thoughts..." required
                            style="width: 100%;"></textarea>
                    </div>
                    <button type="submit" class="primary-btn">Submit Review</button>
                </form>
            </div>
            {% else %}
            <div class="glass-panel" style="padding: 2rem; margin-bottom: 2rem; text-align: center;">
                <p>Please <a href="/login?next={{ request.path }}" style="color: var(--primary-color);">login</a> to
                    leave a review.</p>
            </div>
            {% endif %}

            <div class="reviews-list">
                {% if reviews %}
                {% for review in reviews %}
                <div class="review-card glass-panel" id="review-card-{{ review.id }}"
                    style="padding: 1.5rem; margin-bottom: 1rem; transition: all 0.2s; border-left: 3px solid rgba(229,9,20,0.4);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div
                                style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary-color),#c44569);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.9rem;color:white;flex-shrink:0;">
                                {{ review.user.username[0].upper() }}</div>
                            <strong style="font-size: 1rem;">{{ review.user.username }}</strong>
                        </div>
                        <span style="color: #ffd700; font-size: 1.05rem; letter-spacing: 1px;">
                            {% for i in range(review.rating) %}‚òÖ{% endfor %}{% for i in range(5 - review.rating) %}<span
                                style="color:#3a3a3a;">‚òÖ</span>{% endfor %}
                        </span>
                    </div>
                    <p style="color: #ddd; margin-bottom: 0.75rem; line-height: 1.6;">{{ review.comment }}</p>
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
                        <small style="color: #666;">{{ review.created_at.strftime('%b %d, %Y') }}</small>
                        {% if current_user.is_authenticated %}
                        <button class="like-btn {% if current_user.id in review.liked_by_ids %}liked{% endif %}"
                            id="like-btn-{{ review.id }}" onclick="toggleReviewLike({{ review.id }})"
                            style="background: none; border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 0.3rem 0.8rem; color: var(--text-secondary); cursor: pointer; font-family: inherit; font-size: 0.82rem; display: flex; align-items: center; gap: 0.35rem; transition: all 0.2s;">
                            <span id="like-icon-{{ review.id }}">{% if current_user.id in review.liked_by_ids %}‚ù§Ô∏è{%
                                else %}ü§ç{% endif %}</span>
                            <span id="like-count-{{ review.id }}">{{ review.get_like_count() }}</span>
                        </button>
                        {% else %}
                        <span style="font-size: 0.82rem; color: #666;">ü§ç {{ review.get_like_count() }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p style="color: #888;">No reviews yet. Be the first!</p>
                {% endif %}
            </div>
        </section>

        <!-- Trailer Section -->
        {% if movie.trailer_url %}
        <section class="trailer-section" style="margin-bottom: 4rem;">
            <h2 style="border-left: 4px solid var(--primary-color); padding-left: 1rem; margin-bottom: 2rem;">Official
                Trailer</h2>
            <div class="video-container glass-panel" style="padding: 10px;">
                <div
                    style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px;">
                    <iframe src="{{ movie.trailer_url }}" frameborder="0" allowfullscreen
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    </iframe>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Similar Movies -->
        {% if movie.similar %}
        <section class="similar-section" style="margin-bottom: 4rem;">
            <h2 style="border-left: 4px solid var(--primary-color); padding-left: 1rem; margin-bottom: 2rem;">You May
                Also Like</h2>
            <div class="movie-grid">
                {% for sim in movie.similar %}
                <div class="movie-card"
                    onclick="window.location.href='{{ url_for('movie_details_by_id', tmdb_id=sim.id) if sim.id else '/movie/' + (sim.title|urlencode) }}'">
                    <img src="{{ 'https://image.tmdb.org/t/p/w500' + sim.poster_path if sim.poster_path else 'https://via.placeholder.com/200x300' }}"
                        alt="{{ sim.title }}" class="movie-poster">
                    <div class="movie-hover-overlay">
                        <div class="play-icon">
                            <svg viewBox="0 0 24 24" fill="white">
                                <polygon points="5,3 19,12 5,21" />
                            </svg>
                        </div>
                    </div>
                    <div class="movie-info">
                        <h3 class="movie-title">{{ sim.title }}</h3>
                        <div class="movie-meta">
                            <span class="rating">‚≠ê {{ sim.vote_average | round(1) }}</span>
                            <span class="year">{{ sim.release_date[:4] if sim.release_date else '' }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const movieData = JSON.parse(document.getElementById('movie-data').textContent);

    // Track this movie in Recently Viewed (localStorage)
    (function trackRecentlyViewed() {
        try {
            const RV_KEY = 'mm_recently_viewed';
            const RV_MAX = 12;
            let stored = JSON.parse(localStorage.getItem(RV_KEY) || '[]');
            stored = stored.filter(i => i.title !== movieData.title);
            stored.unshift({ title: movieData.title, poster: movieData.poster_path || null });
            if (stored.length > RV_MAX) stored = stored.slice(0, RV_MAX);
            localStorage.setItem(RV_KEY, JSON.stringify(stored));
        } catch (e) { /* silently ignore */ }
    })();

    async function toggleWatchlist() {
        const btn = document.getElementById('watchlist-btn');
        btn.disabled = true;

        try {
            const response = await fetch('/api/watchlist/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: movieData.title,
                    poster_path: movieData.poster_path,
                    id: movieData.id
                })
            });

            const data = await response.json();
            btn.disabled = false;

            if (data.success) {
                if (data.action === 'added') {
                    btn.innerText = 'Remove from Watchlist';
                    btn.classList.add('active');
                    btn.style.background = '#333';
                    btn.style.border = '1px solid var(--primary-color)';
                    if (typeof toast !== 'undefined') toast.success('Added to Watchlist!');
                } else {
                    btn.innerText = 'Add to Watchlist';
                    btn.classList.remove('active');
                    btn.style.background = '';
                    btn.style.border = '';
                    if (typeof toast !== 'undefined') toast.info('Removed from Watchlist');
                }
            } else {
                if (typeof toast !== 'undefined') toast.error('Error updating watchlist');
            }
        } catch (e) {
            console.error(e);
            btn.disabled = false;
        }
    }

    // Share functions
    function shareOnX() {
        const title = encodeURIComponent(`Check out "${movieData.title}" on Movie Maverick!`);
        const url = encodeURIComponent(window.location.href);
        window.open(`https://twitter.com/intent/tweet?text=${title}&url=${url}`, '_blank');
    }

    function shareOnWhatsApp() {
        const text = encodeURIComponent(`Check out "${movieData.title}" on Movie Maverick! ${window.location.href}`);
        window.open(`https://wa.me/?text=${text}`, '_blank');
    }

    async function copyLink() {
        try {
            await navigator.clipboard.writeText(window.location.href);
            const btn = document.getElementById('share-copy');
            const orig = btn.innerHTML;
            btn.innerHTML = '‚úÖ Copied!';
            btn.style.color = '#4ade80';
            setTimeout(() => { btn.innerHTML = orig; btn.style.color = ''; }, 2000);
        } catch (e) {
            if (typeof toast !== 'undefined') toast.error('Could not copy link');
        }
    }

    let currentRating = 0;
    function setRating(n) {
        currentRating = n;
        document.getElementById('rating-input').value = n;
        const stars = document.querySelectorAll('.star-rating span');
        stars.forEach((star, index) => {
            star.style.color = index < n ? '#ffd700' : '#444';
        });
    }

    async function submitReview(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/submit_review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    movie_title: movieData.title,
                    rating: currentRating,
                    comment: formData.get('comment')
                })
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                if (typeof toast !== 'undefined') toast.error(data.message || 'Error submitting review');
                else alert(data.message || 'Error submitting review');
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error(error);
            submitBtn.disabled = false;
        }
    }

    async function toggleReviewLike(reviewId) {
        try {
            const res = await fetch(`/api/reviews/${reviewId}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('like-count-' + reviewId).textContent = data.like_count;
                document.getElementById('like-icon-' + reviewId).textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
                const btn = document.getElementById('like-btn-' + reviewId);
                if (btn) {
                    btn.style.borderColor = data.liked ? 'rgba(229,9,20,0.5)' : 'rgba(255,255,255,0.15)';
                    btn.style.color = data.liked ? 'var(--primary-color)' : 'var(--text-secondary)';
                }
            }
        } catch (err) { console.error(err); }
    }
</script>
{% endblock %}